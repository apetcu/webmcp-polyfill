{"version":3,"sources":["../src/index.ts","../src/polyfill.ts"],"sourcesContent":["export { initPolyfill, createModelContextClient } from \"./polyfill\";\nexport type {\n  ModelContext,\n  ModelContextTool,\n  ModelContextOptions,\n  ModelContextClient,\n  ToolAnnotations,\n  ToolExecuteCallback,\n  ToolResponse,\n  ToolResponseContent,\n  UserInteractionCallback,\n  WebMCPDebug,\n} from \"./types\";\n","import type {\n  ModelContext,\n  ModelContextTool,\n  ModelContextOptions,\n  ModelContextClient,\n  WebMCPDebug,\n} from \"./types\";\n\nfunction validateInput(\n  schema: Record<string, unknown>,\n  input: Record<string, unknown>\n): string | null {\n  if (schema.type === \"object\") {\n    if (typeof input !== \"object\" || input === null || Array.isArray(input)) {\n      return \"Expected input to be an object\";\n    }\n\n    const required = schema.required;\n    if (Array.isArray(required)) {\n      for (const field of required) {\n        if (!(field as string in input)) {\n          return `Missing required field: ${field}`;\n        }\n      }\n    }\n\n    const properties = schema.properties as\n      | Record<string, Record<string, unknown>>\n      | undefined;\n    if (properties) {\n      for (const [key, propSchema] of Object.entries(properties)) {\n        if (!(key in input)) continue;\n        const value = input[key];\n        const expectedType = propSchema.type as string | undefined;\n        if (!expectedType) continue;\n\n        let valid = true;\n        switch (expectedType) {\n          case \"string\":\n            valid = typeof value === \"string\";\n            break;\n          case \"number\":\n          case \"integer\":\n            valid = typeof value === \"number\";\n            break;\n          case \"boolean\":\n            valid = typeof value === \"boolean\";\n            break;\n          case \"array\":\n            valid = Array.isArray(value);\n            break;\n          case \"object\":\n            valid =\n              typeof value === \"object\" &&\n              value !== null &&\n              !Array.isArray(value);\n            break;\n        }\n        if (!valid) {\n          return `Field \"${key}\" expected type \"${expectedType}\", got \"${typeof value}\"`;\n        }\n      }\n    }\n  }\n\n  return null;\n}\n\nfunction createModelContext(): ModelContext {\n  const baseTools = new Map<string, ModelContextTool>();\n  const dynamicTools = new Map<string, ModelContextTool>();\n\n  const callHistory: WebMCPDebug[\"callHistory\"] = [];\n\n  function getAllTools(): Map<string, ModelContextTool> {\n    const merged = new Map<string, ModelContextTool>();\n    baseTools.forEach((tool, name) => merged.set(name, tool));\n    dynamicTools.forEach((tool, name) => merged.set(name, tool));\n    return merged;\n  }\n\n  function wrapExecute(tool: ModelContextTool): ModelContextTool {\n    const originalExecute = tool.execute;\n    return {\n      ...tool,\n      execute: async (input, client) => {\n        if (tool.inputSchema) {\n          const error = validateInput(\n            tool.inputSchema as Record<string, unknown>,\n            input\n          );\n          if (error) {\n            const entry = {\n              tool: tool.name,\n              input,\n              timestamp: Date.now(),\n              error,\n            };\n            callHistory.push(entry);\n            throw new Error(`Input validation failed: ${error}`);\n          }\n        }\n\n        const entry: (typeof callHistory)[number] = {\n          tool: tool.name,\n          input,\n          timestamp: Date.now(),\n        };\n\n        try {\n          const result = await originalExecute(input, client);\n          entry.result = result;\n          callHistory.push(entry);\n          return result;\n        } catch (err) {\n          entry.error = err instanceof Error ? err.message : String(err);\n          callHistory.push(entry);\n          throw err;\n        }\n      },\n    };\n  }\n\n  const modelContext: ModelContext = {\n    provideContext(options?: ModelContextOptions): void {\n      baseTools.clear();\n      if (options?.tools) {\n        for (const tool of options.tools) {\n          if (dynamicTools.has(tool.name)) {\n            throw new Error(\n              `Tool \"${tool.name}\" already registered as a dynamic tool`\n            );\n          }\n          baseTools.set(tool.name, wrapExecute(tool));\n        }\n      }\n      updateDebug();\n    },\n\n    clearContext(): void {\n      baseTools.clear();\n      dynamicTools.clear();\n      updateDebug();\n    },\n\n    registerTool(tool: ModelContextTool): void {\n      if (baseTools.has(tool.name) || dynamicTools.has(tool.name)) {\n        throw new Error(`Tool \"${tool.name}\" is already registered`);\n      }\n      dynamicTools.set(tool.name, wrapExecute(tool));\n      updateDebug();\n    },\n\n    unregisterTool(name: string): void {\n      const deletedBase = baseTools.delete(name);\n      const deletedDynamic = dynamicTools.delete(name);\n      if (!deletedBase && !deletedDynamic) {\n        throw new Error(`Tool \"${name}\" is not registered`);\n      }\n      updateDebug();\n    },\n  };\n\n  const debug: WebMCPDebug = {\n    tools: getAllTools(),\n    callHistory,\n  };\n\n  function updateDebug() {\n    debug.tools = getAllTools();\n  }\n\n  if (typeof window !== \"undefined\") {\n    (window as unknown as Record<string, unknown>).__webmcp = debug;\n  }\n\n  return modelContext;\n}\n\n/**\n * Create a default ModelContextClient that passes through\n * user interaction callbacks.\n */\nexport function createModelContextClient(): ModelContextClient {\n  return {\n    requestUserInteraction: async (callback) => {\n      return await callback();\n    },\n  };\n}\n\n/**\n * Initialize the WebMCP polyfill.\n *\n * Adds `navigator.modelContext` if it doesn't already exist natively.\n * Safe to call multiple times â€” subsequent calls are no-ops.\n * No-ops in non-browser environments (SSR).\n */\nexport function initPolyfill(): void {\n  if (typeof window === \"undefined\" || typeof navigator === \"undefined\") {\n    return;\n  }\n\n  // Skip if native implementation or previous polyfill exists\n  if (\"modelContext\" in navigator) {\n    return;\n  }\n\n  const modelContext = createModelContext();\n\n  Object.defineProperty(navigator, \"modelContext\", {\n    value: modelContext,\n    writable: false,\n    enumerable: true,\n    configurable: false,\n  });\n}\n"],"mappings":"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","names":["entry"]}